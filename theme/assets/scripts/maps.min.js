function initialize(){var mapOptions={zoom:4,mapTypeControl:!1,streetViewControl:!1,center:new google.maps.LatLng(-12.709053,-51.110798),mapTypeId:google.maps.MapTypeId.ROADMAP};map=new google.maps.Map(document.getElementById("map_canvas"),mapOptions);var markerClusterStyle=[{textColor:"white",url:urlTemplate+"/assets/images/maps/m1.png",height:52,width:52}];markerCluster=new MarkerClusterer(map),markerCluster.setStyles(markerClusterStyle),google.maps.event.addListener(map,"click",function(event){var latitude=event.latLng.lat(),longitude=event.latLng.lng();infowindow.close(),map.panTo(new google.maps.LatLng(latitude,longitude))}),geocoder=new google.maps.Geocoder}function eachWord(str){return str.replace(/\w\S*/g,function(txt){return txt.charAt(0).toUpperCase()+txt.substr(1).toLowerCase()})}function getCapitulos(){$.ajax({type:"GET",url:urlApi+"/capitulos_mapa/format/json",success:function(json){$.each(json,function(index,capitulo){if(!capitulo.geolocal)return!0;var geolocal=capitulo.geolocal.split(","),nome="Capítulo "+eachWord(capitulo.nm_cap)+" Nº"+capitulo.nr_cap,attributes={latitude:geolocal[0],longitude:geolocal[1],tipo:"capitulo",nome:nome,endereco:eachWord(capitulo.end_ds),complemento:eachWord(capitulo.end_complemento),cep:capitulo.end_cep,email:capitulo.con_email?capitulo.con_email.toLowerCase():"",site:capitulo.con_site?capitulo.con_site.toLowerCase():"",cidade:eachWord(capitulo.NM_CIDADE),estado:capitulo.uf_gce,situacao:capitulo.st_atual};makeMarker(attributes)}),markerCluster instanceof MarkerClusterer&&markerCluster.addMarkers(markerListCapitulos)},complete:function(){ajaxCount++}})}function getConventos(){$.ajax({type:"GET",url:urlApi+"/conventos_mapa/format/json",dataType:"json",success:function(json){$.each(json,function(index,capitulo){if(!capitulo.geolocal)return!0;var geolocal=capitulo.geolocal.split(","),nome="Convento "+eachWord(capitulo.nm_convento)+" Nº"+capitulo.nr_convento,attributes={latitude:geolocal[0],longitude:geolocal[1],tipo:"convento",nome:nome,endereco:eachWord(capitulo.end_ds),complemento:eachWord(capitulo.end_complemento),cep:capitulo.end_cep,email:capitulo.con_email?capitulo.con_email.toLowerCase():"",site:capitulo.con_site?capitulo.con_site.toLowerCase():"",cidade:eachWord(capitulo.NM_CIDADE),estado:capitulo.uf_gce,situacao:capitulo.st_atual};makeMarker(attributes)}),markerCluster instanceof MarkerClusterer&&markerCluster.addMarkers(markerListConventos)},complete:function(){ajaxCount++}})}function makeMarker(attributes){var iconMarker;switch(attributes.tipo){case"capitulo":iconMarker=urlTemplate+"/assets/images/maps/marker-capitulo.png";break;case"convento":iconMarker=urlTemplate+"/assets/images/maps/marker-convento.png"}var marker=new google.maps.Marker({map:map,position:new google.maps.LatLng(attributes.latitude,attributes.longitude),title:attributes.nome,icon:iconMarker}),contentString='<div id="info-content"><table><tr id="iw-url-row" class="iw_table_row"><td id="iw-url" class="iw_title" colspan="2">'+attributes.nome+'</td></tr><tr id="iw-address-row" class="iw_table_row"><td class="iw_attribute_name">Endereço:</td><td id="iw-address">'+attributes.endereco+'</td></tr><tr id="iw-cidade-row" class="iw_table_row"><td class="iw_attribute_name">Cidade:</td><td id="iw-cidade">'+attributes.cidade+" - "+attributes.estado+'</td></tr><tr id="iw-cep-row" class="iw_table_row"><td class="iw_attribute_name">CEP:</td><td id="iw-cep">'+attributes.cep+"</td></tr>";switch(attributes.email&&(contentString=contentString+'<tr id="iw-email-row" class="iw_table_row"><td class="iw_attribute_name">Email:</td><td id="iw-email"><a href="mailto:'+attributes.email+'" target="_blank">'+attributes.email+"</a></td></tr>"),attributes.site&&(contentString=contentString+'<tr id="iw-website-row" class="iw_table_row"><td class="iw_attribute_name">Website:</td><td id="iw-website"><a href="http://'+attributes.site+'" target="_blank">'+attributes.site+"</a></td></tr>"),contentString+="</table></div>",infowindow=new google.maps.InfoWindow({content:contentString,maxWidth:200}),google.maps.event.addListener(marker,"click",function(){infowindow&&infowindow.close(),infowindow=new google.maps.InfoWindow({content:contentString,maxWidth:700}),infowindow.open(map,marker),map.panTo(marker.getPosition())}),attributes.tipo){case"capitulo":markerListCapitulos.push(marker);break;case"convento":markerListConventos.push(marker)}}function changeMapType(mapType){map.setMapTypeId(google.maps.MapTypeId[mapType])}function removeCapitulos(){if(markerCluster instanceof MarkerClusterer){for(var i=0;i<markerListCapitulos.length;i++)markerListCapitulos[i].setMap(null);markerListCapitulos=[],markerCluster.clearMarkers()}}function removeConventos(){if(markerCluster instanceof MarkerClusterer){for(var i=0;i<markerListConventos.length;i++)markerListConventos[i].setMap(null);markerListConventos=[],markerCluster.clearMarkers()}}var urlApi="http://www.wsold.demolay.org.br/api",urlTemplate=common_params.files_url,map,infowindow,geocoder,markerCluster,markerListCapitulos=[],markerListConventos=[],ajaxCount;initialize(),$(document).ready(function(){function updateMap(){ajaxCount=0,$("#map_overlay").addClass("open"),$("#showCapitulos").prop("checked")?(removeCapitulos(),getCapitulos()):(removeCapitulos(),ajaxCount++),$("#showConventos").prop("checked")?(removeConventos(),getConventos()):(removeConventos(),ajaxCount++)}function goMapTo(endereco){geocoder.geocode({address:endereco+", Brasil",region:"BR"},function(results,status){if(status===google.maps.GeocoderStatus.OK&&results[0]){var latitude=results[0].geometry.location.lat(),longitude=results[0].geometry.location.lng();$("#txtEndereco").val(results[0].formatted_address),$("#txtLatitude").val(latitude),$("#txtLongitude").val(longitude);var location=new google.maps.LatLng(latitude,longitude);map.panTo(location),map.setZoom(13)}})}updateMap(),$(document).ajaxComplete(function(){2===ajaxCount&&($("#map_overlay").removeClass("open"),ajaxCount=0)}),$("#mapTypeRoadmap").on("ifChecked",function(){changeMapType("ROADMAP")}),$("#mapTypeSatellite").on("ifChecked",function(){changeMapType("HYBRID")}),$("#txtEndereco").autocomplete({delay:80,source:function(request,response){geocoder.geocode({address:request.term+", Brasil",region:"BR"},function(results){response($.map(results,function(item){return{label:item.formatted_address,value:item.formatted_address,latitude:item.geometry.location.lat(),longitude:item.geometry.location.lng()}}))})},select:function(event,ui){$("#txtLatitude").val(ui.item.latitude),$("#txtLongitude").val(ui.item.longitude);var location=new google.maps.LatLng(ui.item.latitude,ui.item.longitude);map.panTo(location),map.setZoom(13)}}),$("#txtEndereco").blur(function(){""!==$(this).val()&&goMapTo($(this).val())}),$("#showCapitulos").on("ifToggled",function(){updateMap()}),$("#showConventos").on("ifToggled",function(){updateMap()})});